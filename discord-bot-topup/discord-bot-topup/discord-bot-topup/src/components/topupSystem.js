import { 
  ActionRowBuilder, 
  ButtonBuilder, 
  ButtonStyle, 
  StringSelectMenuBuilder,
  MessageFlags
} from 'discord.js';
import databaseService from "../services/databaseService.js";
import qrCodeService from "../services/qrCodeService.js";
import slipVerification from "./slipVerification.js";
import rconManager from "./rconManager.js";
import logService from "../services/logService.js";
import Helpers from "../utils/helpers.js";
import CONSTANTS from "../utils/constants.js";
import configService from "../services/configService.js";

// Import utilities
import BrandUtils from "../utils/brandUtils.js";
import EmbedBuilders from "../utils/embedBuilders.js";
import Validators from "../utils/validators.js";
import TicketManager from "../utils/ticketManager.js";

class TopupSystem {
  constructor(client) {
    this.client = client;
    this.activeTickets = new Map();
    this.userCooldowns = new Map();
  }

  async init() {
    console.log("üéÆ NEXArk Topup System initialized");
    await this.registerCommands();
    this.setupEventListeners();
    await this.setupMenuChannel();
    await this.startPeriodicTasks();
    
    // Cleanup old temp files periodically
    setInterval(() => {
      Helpers.cleanupTempFiles();
    }, 3600000);
  }

  async registerCommands() {
    const commands = [
      {
        name: "setup_menu",
        description: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å (Admin only)",
      },
      {
        name: "setup_scoreboard",
        description: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ scoreboard (Admin only)",
      },
    ];

    try {
      await this.client.application.commands.set(commands);
      console.log("‚úÖ NEXArk commands registered successfully");
    } catch (error) {
      console.error("‚ùå Error registering commands:", error);
    }
  }

  setupEventListeners() {
    this.client.on("interactionCreate", async (interaction) => {
      try {
        if (interaction.isCommand()) {
          await this.handleSlashCommands(interaction);
        }
      } catch (error) {
        logService.error("Command interaction error:", error);
      }
    });
  }

  async setupMenuChannel() {
    try {
      const config = configService.getConfig();
      const menuChannelId = config.channels?.menu_channel_id;
      
      if (!menuChannelId) {
        console.warn('‚ö†Ô∏è No menu channel configured');
        return;
      }

      const channel = this.client.channels.cache.get(menuChannelId);
      if (!channel) {
        console.error('‚ùå Menu channel not found:', menuChannelId);
        return;
      }

      // Clear old messages
      try {
        const messages = await channel.messages.fetch({ limit: 10 });
        const botMessages = messages.filter(m => m.author.id === this.client.user.id);
        if (botMessages.size > 0) {
          await channel.bulkDelete(botMessages);
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Could not clear old messages:', error.message);
      }

      await this.sendMainMenu(channel);
      console.log('‚úÖ NEXArk main menu sent to channel:', menuChannelId);

    } catch (error) {
      console.error('‚ùå Error setting up menu channel:', error);
    }
  }

  async sendMainMenu(channel) {
    const embed = EmbedBuilders.createMainMenuEmbed();
    const buttons = new ActionRowBuilder()
      .addComponents(
        new ButtonBuilder()
          .setCustomId('donate_points')
          .setLabel('üí∞ ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó‡∏û‡πâ‡∏≠‡∏¢')
          .setStyle(ButtonStyle.Success)
          .setEmoji('üíé'),
        new ButtonBuilder()
          .setCustomId('donate_ranks')
          .setLabel('üëë ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó‡∏¢‡∏®')
          .setStyle(ButtonStyle.Primary)
          .setEmoji('‚≠ê'),
        new ButtonBuilder()
          .setCustomId('donate_items')
          .setLabel('üéÅ ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó‡πÑ‡∏≠‡πÄ‡∏ó‡∏°')
          .setStyle(ButtonStyle.Secondary)
          .setEmoji('üé™'),
        new ButtonBuilder()
          .setCustomId('support_ticket')
          .setLabel('üé´ ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤')
          .setStyle(ButtonStyle.Danger)
          .setEmoji('üÜò')
      );

    await channel.send({
      embeds: [embed],
      components: [buttons]
    });
  }

  async handleButtonInteraction(interaction) {
    const { customId, user } = interaction;
  
    try {
      switch (customId) {
        case 'donate_points':
          await interaction.deferReply({ flags: MessageFlags.Ephemeral });
          await this.showDonationCategory(interaction, 'points');
          break;
          
        case 'donate_ranks':
          await interaction.deferReply({ flags: MessageFlags.Ephemeral });
          await this.showDonationCategory(interaction, 'ranks');
          break;
          
        case 'donate_items':
          await interaction.deferReply({ flags: MessageFlags.Ephemeral });
          await this.showDonationCategory(interaction, 'items');
          break;
          
        case 'support_ticket':
          await interaction.deferReply({ flags: MessageFlags.Ephemeral });
          await this.createSupportTicket(interaction);
          break;
  
        case 'cancel_donation':
          await interaction.deferReply();
          await this.cancelDonation(interaction);
          break;
          
        default:
          if (customId.startsWith('select_donation_')) {
            await interaction.deferReply({ flags: MessageFlags.Ephemeral });
            await this.handleDonationSelection(interaction);
          } else if (customId.startsWith('close_ticket_')) {
            await interaction.deferReply();
            await this.closeSupportTicket(interaction);
          }
          break;
      }
    } catch (error) {
      logService.error('Button interaction error:', error);
      
      if (!interaction.replied && !interaction.deferred) {
        await interaction.reply({
          content: '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
          flags: MessageFlags.Ephemeral
        });
      } else {
        await interaction.editReply({
          content: '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
        });
      }
    }
  }

  async showDonationCategory(interaction, category) {
    const userId = interaction.user.id;
    
    // Check cooldown
    if (!Validators.validateCooldown(this.userCooldowns, userId)) {
      return await interaction.editReply({
        content: '‚è∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà'
      });
    }
  
    // Check user link status
    const userGameInfo = await databaseService.getUserGameInfo(userId);
    if (!Validators.validateUserGameInfo(userGameInfo, category)) {
      if (!userGameInfo.isLinked) {
        const embed = EmbedBuilders.createNoLinkEmbed();
        return await interaction.editReply({ embeds: [embed] });
      }
      
      if (category === 'items' && !userGameInfo.characterId) {
        const embed = EmbedBuilders.createErrorEmbed(
          '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£',
          '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏ô‡πÄ‡∏Å‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'
        );
        return await interaction.editReply({ embeds: [embed] });
      }
    }
  
    // Check active donation tickets
    const activeDonationTickets = await databaseService.getActiveDonationTickets(userId);
    if (activeDonationTickets.length >= CONSTANTS.TICKET.MAX_TICKETS_PER_USER) {
      const embed = EmbedBuilders.createMaxTicketEmbed(
        activeDonationTickets, 
        CONSTANTS.TICKET.MAX_TICKETS_PER_USER
      );
      return await interaction.editReply({ embeds: [embed] });
    }
  
    try {
      const config = configService.getConfig();
      const donations = config.donation_categories[category];
  
      if (!donations || donations.length === 0) {
        return await interaction.editReply({
          content: '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ'
        });
      }
  
      const selectMenu = new StringSelectMenuBuilder()
        .setCustomId(`select_donation_${category}`)
        .setPlaceholder(`üî• ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å${BrandUtils.categoryDisplayNames[category]}‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${BrandUtils.categoryIcons[category]}`)
        .addOptions(
          donations.map(item => ({
            label: `${item.name}`,
            description: `üí∞ ${Helpers.formatCurrency(item.price)} | ${item.description}`,
            value: item.id,
            emoji: BrandUtils.categoryIcons[category]
          }))
        );
  
      const row = new ActionRowBuilder().addComponents(selectMenu);
      const embed = EmbedBuilders.createCategorySelectionEmbed(
        category, 
        userGameInfo, 
        activeDonationTickets, 
        CONSTANTS.TICKET.MAX_TICKETS_PER_USER, 
        donations
      );
  
      await interaction.editReply({
        embeds: [embed],
        components: [row]
      });
  
      // Set cooldown
      this.userCooldowns.set(userId, Date.now());
  
    } catch (error) {
      logService.error('Error showing donation category:', error);
      await interaction.editReply({
        content: '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
      });
    }
  }

  // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ methods ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏•‡∏á‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ utilities...
  
  async handleSelectMenuInteraction(interaction) {
    if (interaction.customId.startsWith("select_donation_")) {
      await this.handleDonationSelection(interaction);
    }
  }

  async handleSlashCommands(interaction) {
    // Implementation...
  }

  async handleDonationSelection(interaction) {
    // Implementation ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ EmbedBuilders...
  }

  async createDonationTicket(interaction, donationItem, category, userGameInfo) {
    // Implementation ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ TicketManager...
  }

  async createSupportTicket(interaction) {
    // Implementation ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ EmbedBuilders ‡πÅ‡∏•‡∏∞ TicketManager...
  }

  async handleSlipSubmission(message) {
    // Implementation ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Validators...
  }

  async cancelDonation(interaction) {
    // Implementation...
  }

  async closeSupportTicket(interaction) {
    // Implementation...
  }

  async startPeriodicTasks() {
    // Cleanup expired tickets every 30 minutes
    setInterval(() => {
      TicketManager.cleanupExpiredTickets(this.activeTickets, this.client);
    }, 1800000);
    
    console.log('üîÑ NEXArk periodic tasks started');
  }

  async shutdown() {
    console.log('üõë NEXArk Topup System shutting down...');
    this.activeTickets.clear();
    this.userCooldowns.clear();
    console.log('‚úÖ NEXArk Topup System shutdown complete');
  }
}

export default TopupSystem;